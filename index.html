<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>IDentify</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>IDentify</h1>
    <h2>School Barcode Scanner Log</h2>
    <p>Please allow camera access to start scanning.</p>

    <div class="scanner-box">
      <div id="reader-container">
        <div id="reader" class="scanning"></div>
        <div id="loadingMsg">Initializing camera...</div>
      </div>

      <button id="scanAnotherBtn" style="display:none;">Scan Another</button>
    </div>

    <h3>Scan Log</h3>
    <div class="table-container">
      <table id="log">
        <tr>
          <th>Name</th>
          <th>ID Number</th>
          <th>Date</th>
          <th>Time</th>
        </tr>
      </table>
    </div>
  </div>

  <script>
    const SHEETS_URL = "https://script.google.com/macros/s/AKfycbz5ImcplB3Q4JnjHdYLZj4qA04Cg7U0g0-jeaRmEzORG9U8WwsvbWbpHOZPv5DFj2uv/exec";

    //Student data ID - Name
    const students = {
      "20140004428": "Matthew Ethan M. Abadiano",
      "20240031427": "Bridgette Marie D. Abastas",
      "20180015366": "Glysalen L. Abogaa",
      "00201131743": "Florido III S. Akut",
      "20200020945": "Zuhair Alauya",
      "20240029697": "Sittie Naylah D. Ariong",
      "20240029980": "Phillip Jaspher A. Baja",
      "20220025798": "Julia Paula I. Bandivas",
      "20240030612": "Jade Andrea B. Borcelas",
      "20240030286": "Reginald Kristoff M. Cahig",
      "2013000679": "Kristine Joy Capao",
      "20200020342": "Gwyneth C. Daayata",
      "20200020048": "Mika Arabella R. Dacut",
      "20170012479": "Mohammad Dipatuan",
      "00201120194": "Ralph B. Delicana Jr",
      "20200020151": "Jamie Iñigo S. Dapal Jr",
      "20200019713": "Andren Marie B. Eligan",
      "20220026221": "Eric Juan L. Emano",
      "20200019971": "Jeff Wilson B. Galinada",
      "00201120182": "Maria Patrizia S. Go",
      "00201130543": "Sairish Guiling",
      "20200020346": "Abdul Hakim H. Hadji Omar",
      "20240029940": "Miguel Gabriel C. Hernandez",
      "00201210663": "Jathena Verra B. Ibarra",
      "20240030932": "Althea Gaia Lagos",
      "00201131156": "Niña Margarette P. Ledesma",
      "20240030603": "Josh Van Manuel Lozano",
      "20240029864": "Elreina Lucilio",
      "00201131410": "Nicole Lugtu",
      "20200020702": "Luke Ode Maguyon",
      "20160010435": "Klyde Xedric S. Meneses",
      "20200020142": "Hannah Faith U. Micabalo",
      "20140006704": "Jet Mundo",
      "20170011908": "Giam Paolo P. Olaer",
      "20190018486": "Muhammad Jasim D. Pandi",
      "20170011882": "Kish Micah G. Pelisco",
      "20240029897": "Reeze Vievien R. Sacote",
      "20200019906": "Liancel Marie S. Valencia",
      "20200020562": "Patrowe Trishfel Yamba",
      "20240030219": "Vaneza Jane L. Zamoranos"
    };

    //Keep track of scanned IDs (avoid duplicates)
    const scannedIds = new Set();

    const reader = document.getElementById("reader");
    const loadingMsg = document.getElementById("loadingMsg");
    const scanAnotherBtn = document.getElementById("scanAnotherBtn");

    function addLog(name, idNumber) {
      const now = new Date();
      const date = now.toLocaleDateString();
      const time = now.toLocaleTimeString();

      const table = document.getElementById("log");
      const row = table.insertRow(-1);
      row.insertCell(0).textContent = name;
      row.insertCell(1).textContent = idNumber;
      row.insertCell(2).textContent = date;
      row.insertCell(3).textContent = time;

      // Send data to Google Sheets
      fetch(SHEETS_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          name: name,
          id: idNumber,
          date: date,
          time: time
        })
      });
    }

    function startScanner() {
      loadingMsg.style.display = "block";
      scanAnotherBtn.style.display = "none";

      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: reader,
          constraints: { facingMode: "environment" }
        },
        decoder: {
          readers: ["code_128_reader","ean_reader"]
        },
        locate: true
      }, function(err) {
        if (err) {
          console.error("Quagga init error:", err);
          alert("Camera initialization failed. Please refresh or check permissions.");
          loadingMsg.textContent = "Unable to access camera.";
          scanAnotherBtn.style.display = "block";
          return;
        }

        loadingMsg.style.display = "none";
        reader.classList.add("scanning");
        Quagga.start();
        console.log("Quagga initialized successfully.");
      });

      Quagga.onDetected((data) => {
        const idNumber = data.codeResult.code.trim();
        console.log("Detected ID:", idNumber);

        // Prevent multiple detections of same code
        if (scannedIds.has(idNumber)) {
          alert(`ID ${idNumber} has already been scanned!`);
          return;
        }

        const name = students[idNumber];
        if (!name) {
          alert(`Unknown ID: ${idNumber}. Please check the barcode.`);
          return;
        }

        scannedIds.add(idNumber);
        Quagga.stop();
        reader.classList.remove("scanning");

        addLog(name, idNumber);
        alert(`Scanned successfully:\n${name} (${idNumber})`);
        scanAnotherBtn.style.display = "inline-block";
      });
    }

    scanAnotherBtn.addEventListener("click", () => {
      reader.classList.add("scanning");
      startScanner();
    });

    window.addEventListener("load", startScanner);
  </script>
</body>
</html>
