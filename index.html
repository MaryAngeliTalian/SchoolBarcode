<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>School Barcode Scanner Log</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>
</head>
<body>
  <div class="container">
    <h2>School Barcode Scanner Log</h2>
    <p>Please allow camera access to start scanning.</p>

    <div class="scanner-box">
      <div class="input-section">
        <label for="nameInput"><b>Enter Name:</b></label>
        <input type="text" id="nameInput" placeholder="Type your name...">
      </div>

      <div id="reader-container">
        <div id="reader" class="scanning"></div>
        <div id="loadingMsg">Initializing camera...</div>
      </div>

      <button id="scanAnotherBtn" style="display:none;">Scan Another</button>
    </div>

    <h3>Scan Log</h3>
    <div class="table-container">
      <table id="log">
        <tr>
          <th>Name</th>
          <th>ID Number</th>
          <th>Date</th>
          <th>Time</th>
        </tr>
      </table>
    </div>
  </div>

  <script>
    const SHEETS_URL = "https://script.google.com/macros/s/AKfycbz5ImcplB3Q4JnjHdYLZj4qA04Cg7U0g0-jeaRmEzORG9U8WwsvbWbpHOZPv5DFj2uv/exec";

    const reader = document.getElementById("reader");
    const loadingMsg = document.getElementById("loadingMsg");
    const scanAnotherBtn = document.getElementById("scanAnotherBtn");

    function addLog(name, idNumber) {
      const now = new Date();
      const date = now.toLocaleDateString();
      const time = now.toLocaleTimeString();

      const table = document.getElementById("log");
      const row = table.insertRow(-1);
      row.insertCell(0).textContent = name || "N/A";
      row.insertCell(1).textContent = idNumber;
      row.insertCell(2).textContent = date;
      row.insertCell(3).textContent = time;

      fetch(SHEETS_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          name: name || "N/A",
          id: idNumber,
          date: date,
          time: time
        })
      });
    }

    function startScanner() {
      loadingMsg.style.display = "block";
      scanAnotherBtn.style.display = "none";

      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: reader,
          constraints: { facingMode: "environment" }
        },
        decoder: { readers: ["code_128_reader", "code_39_reader", "ean_reader"] },
        locate: true
      }, function(err) {
        if (err) {
          console.error("Quagga init error:", err);
          alert("Camera initialization failed.");
          loadingMsg.textContent = "Unable to access camera.";
          scanAnotherBtn.style.display = "block";
          return;
        }

        loadingMsg.style.display = "none";
        reader.classList.add("scanning");
        Quagga.start();
        console.log("Quagga initialized successfully.");
      });

      Quagga.onDetected((data) => {
        const decodedText = data.codeResult.code;
        Quagga.stop();
        reader.classList.remove("scanning");

        const name = document.getElementById("nameInput").value.trim();
        const confirmScan = confirm(`Scanned ID: ${decodedText}\n\nConfirm to save this entry?`);

        if (confirmScan) {
          addLog(name, decodedText);
          alert("Scanned successfully!");
        } else {
          alert("Scan cancelled.");
        }

        scanAnotherBtn.style.display = "inline-block";
      });
    }

    scanAnotherBtn.addEventListener("click", () => {
      reader.classList.add("scanning");
      startScanner();
    });

    window.addEventListener("load", startScanner);
  </script>
</body>
</html>
