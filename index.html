<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>School Barcode Scanner Log</title>
  <link rel="stylesheet" href="style.css">
  <!-- âœ… QuaggaJS CDN -->
  <script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>
</head>
<body>
  <div class="container">
    <h2>School Barcode Scanner Log (Google Sheets Connected)</h2>
    <p>Allow camera access when prompted.</p>

    <div class="input-section">
      <label for="nameInput"><b>Enter Name:</b></label>
      <input type="text" id="nameInput" placeholder="Type your name...">
    </div>

    <!-- âœ… QuaggaJS camera view -->
    <div id="reader"></div>

    <h3>ðŸ“‹ Scan Log</h3>
    <div class="table-container">
      <table id="log">
        <tr>
          <th>Name</th>
          <th>ID Number</th>
          <th>Date</th>
          <th>Time</th>
        </tr>
      </table>
    </div>
  </div>

  <script>
    const SHEETS_URL = "https://script.google.com/macros/s/AKfycbzmE3cHM6trDqlWnUPhMermHQ0Nww77gNedLSkFH4Rpx5VWOc8YBy8UhEtnQTskKfNh/exec";

    function addLog(name, idNumber) {
      const now = new Date();
      const date = now.toLocaleDateString();
      const time = now.toLocaleTimeString();

      const table = document.getElementById("log");
      const row = table.insertRow(-1);
      row.insertCell(0).textContent = name || "N/A";
      row.insertCell(1).textContent = idNumber;
      row.insertCell(2).textContent = date;
      row.insertCell(3).textContent = time;

      fetch(SHEETS_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          name: name || "N/A",
          id: idNumber,
          date: date,
          time: time
        })
      });
    }

    // âœ… Initialize QuaggaJS
    function startScanner() {
      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: document.querySelector("#reader"),
          constraints: {
            facingMode: "environment" // use back camera if available
          }
        },
        decoder: {
          readers: [
            "code_128_reader",
            "code_39_reader",
            "ean_reader"
          ]
        },
        locate: true
      }, function(err) {
        if (err) {
          console.error("Quagga init error:", err);
          alert("Camera initialization failed.");
          return;
        }
        console.log("Quagga initialized successfully.");
        Quagga.start();
      });

      // âœ… When barcode detected
      Quagga.onDetected((data) => {
        const decodedText = data.codeResult.code;
        Quagga.stop(); // stop scanner after first detection

        const name = document.getElementById("nameInput").value.trim();
        const confirmScan = confirm(`Scanned ID: ${decodedText}\n\nConfirm to save this entry?`);

        if (confirmScan) {
          addLog(name, decodedText);
          alert("Scanned successfully!");
        } else {
          alert("Scan cancelled.");
        }

        // Restart scanner after a short delay
        setTimeout(() => {
          Quagga.start();
        }, 1500);
      });
    }

    // âœ… Start camera on load
    window.addEventListener("load", startScanner);
  </script>
</body>
</html>
